# API Initialize Link Between Affina and LynkiD Members

This API initializes a link between an **Affina** member (identified by `partnerMemberCode`) and a **LynkiD** member (identified by phone number).  
Upon successful initialization, an OTP will be sent to the provided phone number.  
The link will only be confirmed after verifying the OTP using the `/affina/verifyotp-lynkid-connection` API.

---

## Table of Contents

1. [API Details](#api-details)
    - [Headers](#headers)
    - [Request Body](#request-body)
2. [Sample Request Body](#request)
3. [Sample Response](#response)
    - [Success Case](#success)
    - [Failure Case](#failure)
4. [Notes](#note)
    - [Ensure Unique otpSession](#note-1)
    - [Valid Phone Number](#note-2)
    - [Handling Blocked Phone Numbers](#note-3)
    - [Member Name](#note-4)
5. [Next Steps](#next-step)

---

## 1. API Details <a id="api-details"></a>

-   **Endpoint**: `/affina/init-lynkid-connection`
-   **Method**: `POST`
-   **Data Format**: JSON

### 1.1. Headers <a id="headers"></a>

| Header Name    | Type   | Required | Description                            |
| -------------- | ------ | -------- | -------------------------------------- |
| `X-API-Key`    | String | Yes      | API key provided by LynkiD.            |
| `X-Partner-ID` | String | Yes      | Partner identifier provided by LynkiD. |

### 1.2. Request Body <a id="request-body"></a>

| Field Name            | Type   | Size    | Required | Description                                                                 | Example                                  |
| --------------------- | ------ | ------- | -------- | --------------------------------------------------------------------------- | ---------------------------------------- |
| `otpSession`          | String | Max 255 | Yes      | OTP session identifier, must be unique in the LynkiD system.                | `"98a76b5c-4321-4e89-abcd-0123456789ab"` |
| `partnerMemberCode`   | String | Max 255 | Yes      | Affina member's unique identifier.                                          | `"PARTNER001"`                           |
| `partnerMemberName`   | String | Max 255 | No       | Name of the Affina member (required only for auto-creating LynkiD members). | `"John Doe"`                             |
| `partnerMemberIdCard` | String | Max 255 | Yes      | Affina member's ID card number.                                             | `"1234567890"`                           |
| `phoneNumber`         | String | Max 255 | Yes      | LynkiD member's phone number for linking.                                   | `"+849xxxxx"`                            |

#### **Sample Request JSON**

```json
{
    "otpSession": "98a76b5c-4321-4e89-abcd-0123456789ab",
    "partnerMemberCode": "PARTNER001",
    "partnerMemberName": "John Doe",
    "partnerMemberIdCard": "1234567890",
    "phoneNumber": "+1234567890"
}
```

## 3. Sample Response <a id="response"></a>

### 3.1. Success Case <a id="success"></a>

```json
{
    "otpSession": "98a76b5c-4321-4e89-abcd-0123456789ab",
    "isOtpSent": true,
    "phoneNumber": "+1234567890",
    "code": "00",
    "message": "Success"
}
```

-   Explanation of Response Fields:

| Tên Trường    | Loại    | Mô Tả                                            | Ví Dụ                                    |
| ------------- | ------- | ------------------------------------------------ | ---------------------------------------- |
| `otpSession`  | String  | The OTP session that was created.                | `"98a76b5c-4321-4e89-abcd-0123456789ab"` |
| `isOtpSent`   | Boolean | Indicates whether the OTP was successfully sent. | `true`                                   |
| `phoneNumber` | String  | The phone number the OTP was sent to.            | `"+1234567890"`                          |
| `code`        | String  | Response status code. `00` indicates success.    | `"00"`                                   |
| `message`     | String  | Detailed status message.                         | `"Success"`                              |

### 3.2. Failure Case <a id="failure"></a>

```json
{
  "code": "101",
  "message": "OtpSession duplicated"
}
{
  "code": "102",
  "message": "PhoneNumber is temporarily blocked for new OTP"
}
```

-   Error Code Descriptions:
    | Code | Error Code Descriptions |
    | ---------- | ------ |
    | `00` | Success. The OTP was sent to the provided phone number. |
    | `101` | The otpSession is duplicated and cannot create a new link. |
    | `102` | The phone number is temporarily blocked for new OTPs. |

## 4. Notes <a id="note"></a>

### 4.1 Ensure Unique otpSession <a id="note-1"></a>

-   The otpSession must be generated by the partner and must not duplicate any existing session in the system.

### 4.2 Valid Phone Number <a id="note-2"></a>

-   The phone number must follow the international format (start with + and country code).

### 4.3 Handling Blocked Phone Numbers <a id="note-3"></a>

-   If the phone number is blocked (error 102), wait for the designated cooldown period before retrying.

### 4.4 Member Name <a id="note-4"></a>

-   The partnerMemberName field is only required if the partner intends to auto-create a LynkiD member.

## 5. Next Steps <a id="next-step"></a>

-   Verify OTP to Complete Linking:
    -   Use the `verifyotp-lynkid-connection` API to finalize the link.
-   Check Link Status:
    -   Use another API to verify the link status of the member.
